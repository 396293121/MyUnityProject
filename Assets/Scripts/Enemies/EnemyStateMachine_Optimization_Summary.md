# 敌人状态机系统优化总结

## 优化目标
根据Unity野猪动画控制器的参数和过渡条件，优化敌人状态机系统，实现：
1. 清晰易于维护，解耦合，将敌人状态转换判断放在状态机脚本
2. 性能优化，减少不必要的UPDATE以及状态切换
3. 尽量不改变现有转换逻辑

## 完成的优化工作

### 1. 动画参数名称统一
- **Enemy.cs**: 更新 `UpdateAnimation` 方法，使动画参数与Unity动画控制器一致
  - 设置 `Speed`、`IsAlive`、`IsAttacking` 等参数
  - 保留兼容性参数 `IsMoving`、`IsDead`、`IsPlayerInRange`

- **WildBoar.cs**: 重写 `UpdateAnimation` 方法，添加野猪特有参数
  - 添加 `IsCharging`、`IsStunned` 动画参数
  - 确保与状态机状态同步

### 2. 状态机系统重构
- **EnemyStateMachine.cs**: 完全重构状态机系统
  - **事件驱动优化**: 实现事件驱动的状态转换，减少不必要的Update调用
  - **智能条件缓存**: 缓存状态转换条件，避免重复计算
  - **清晰的状态管理**: 集中管理所有状态转换规则
  - **解耦合设计**: 状态转换逻辑完全在状态机中处理

### 3. 性能优化措施
- **减少Update频率**: 
  - 使用事件驱动机制，只在状态变化时检查转换
  - 实现条件缓存，避免重复计算
  - 限制状态检查频率（每0.1秒检查一次）

- **优化状态检测**:
  - 在 `Enemy.cs` 中优化 `DetectPlayer` 方法，只在范围状态变化时通知状态机
  - 移除重复的组件获取操作

### 4. 代码结构优化
- **状态转换集中管理**: 所有状态转换规则在 `InitializeStateTransitions` 中定义
- **事件系统**: 实现完整的事件通知系统，支持外部状态变化通知
- **公共属性访问器**: 在 `WildBoar.cs` 中添加状态访问器，供状态机使用

### 5. 具体修改内容

#### EnemyStateMachine.cs
- 重构整个类结构，实现事件驱动的状态管理
- 添加状态转换规则集中管理
- 实现性能优化机制（条件缓存、事件驱动）
- 添加完整的外部通知方法

#### Enemy.cs
- 优化 `UpdateAnimation` 方法，统一动画参数名称
- 优化 `DetectPlayer` 方法，实现事件驱动的玩家检测
- 更新 `TakeDamage` 方法，正确通知状态机健康状态变化

#### WildBoar.cs
- 重写 `UpdateAnimation` 方法，添加野猪特有动画参数
- 优化冲撞和眩晕相关方法，使用统一的状态机引用
- 添加公共属性访问器，供状态机访问内部状态
- 在 `Awake` 方法中正确初始化状态机引用

## 优化效果

### 性能提升
- 减少了不必要的Update调用
- 实现了事件驱动的状态管理
- 优化了状态检查频率

### 代码质量提升
- 状态转换逻辑集中管理，易于维护
- 实现了良好的解耦合设计
- 代码结构更加清晰

### 兼容性保证
- 保留了原有的转换逻辑
- 维持了动画参数的兼容性
- 确保了现有功能的正常运行

## 使用说明
1. 确保所有敌人GameObject都有 `EnemyStateMachine` 组件
2. 状态机会自动处理所有状态转换
3. 外部系统可以通过事件通知状态机状态变化
4. 动画参数会自动与Unity动画控制器同步

## 注意事项
- 状态机依赖于正确的组件引用，确保所有必要组件都已添加
- 事件驱动系统需要正确的事件订阅和取消订阅
- 性能优化设置可以根据具体需求调整